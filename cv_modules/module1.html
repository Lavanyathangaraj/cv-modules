<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 1: 3D Dimension Measurement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .content-card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 1rem;
        }
        #object-canvas {
            cursor: crosshair;
            border: 1px dashed #a78bfa;
            background-color: #f9fafb;
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
        .code-display {
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 0.875rem;
            color: #312e81; 
            background-color: #eef2ff; 
            padding: 12px;
            border-radius: 6px;
        }

        #console-results {
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 1rem;
            line-height: 1.5;
            padding: 10px;
            background-color: #f3f4f6; 
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <header class="mb-8 max-w-6xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-900 text-center">Module 1: 3D Dimension Measurement</h1>
        <button onclick="window.location.href='index.html'" class="mt-4 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">
            &larr; Back to Dashboard
        </button>
    </header>

    <main class="max-w-6xl mx-auto">
        <div id="content-module1" class="tab-content">
            <div class="bg-white p-6 md:p-8 rounded-xl content-card border-t-4 border-purple-500">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Real-World Dimension Calculator (Perspective Projection)</h2>
                <p class="text-gray-600 mb-6">Upload an image, enter the object's depth (Z), and click two points on the image to compute its dimensions using perspective projection.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="order-2 md:order-1">
                        <h3 class="text-xl font-medium mb-3 text-purple-600">Image Input & Measurement</h3>
                        
                        <div class="mb-4">
                            <label for="image-upload-m1" class="block text-sm font-medium text-gray-700 mb-2">1. Upload Image of Object:</label>
                            <input type="file" id="image-upload-m1" accept="image/*" class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0
                                file:text-sm file:font-semibold file:bg-purple-100 file:text-purple-700
                                hover:file:bg-purple-200 cursor-pointer
                            ">
                        </div>
                        
                        <form id="calculation-form" class="space-y-4">
                            <div class="flex flex-col">
                                <label for="Z_m1" class="text-sm font-medium text-gray-700 mb-1">2. Object Depth (Z) - cm:</label>
                                <input type="number" id="Z_m1" name="Z" value="0" step="0.1" required class="p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            </div>
                            
                            <div class="pt-4 border-t border-gray-200">
                                <span class="text-sm font-medium text-gray-700 block mb-1">3. Real-World Dimensions for Error Check (cm):</span>
                                <div class="flex space-x-3">
                                    <div class="w-1/2">
                                        <label for="real_dX" class="block text-sm text-gray-700">X (Width):</label>
                                        <input type="number" id="real_dX" placeholder="0" value="0" step="0.1" class="p-3 w-full border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                                    </div>
                                    <div class="w-1/2">
                                        <label for="real_dY" class="block text-sm text-gray-700">Y (Height):</label>
                                        <input type="number" id="real_dY" placeholder="0" value="0" step="0.1" class="p-3 w-full border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                                    </div>
                                </div>
                                </div>
                        </form>

                        <label class="block text-sm font-medium text-gray-700 mt-6 mb-2">4. Click two points on the object in the image below:</label>
                        
                        <p class="text-xs text-gray-500 mt-2 p-2 bg-purple-50 rounded-md">
                            Notes: For a rectangular object, click the Top-Left corner as P1 and the Bottom-Right corner as P2 to ensure both Width (Î”X) and Height (Î”Y) are accurately measured simultaneously.
                        </p>
                        <canvas id="object-canvas" width="400" height="300" class="rounded-lg shadow-md"></canvas>
                        
                        <div class="mt-4 flex space-x-2">
                            <button id="calculate-button-m1" disabled class="w-full bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-150 disabled:bg-gray-400">
                                Calculate Dimension & Error
                            </button>
                            <button id="reset-button-m1" class="w-1/4 bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 transition duration-150">
                                Reset
                            </button>
                        </div>
                    </div>

                    <div class="order-1 md:order-2 bg-gray-50 p-6 rounded-lg border border-gray-200">
                        <h3 class="text-xl font-medium mb-4 text-gray-700">Measurement Results</h3>
                        
                        <div id="results" class="space-y-4">
                            <p class="text-sm text-gray-500 mb-4">Upload image, set depth, and click points to see results.</p>
                            
                            <div id="console-results">
                                Awaiting input...
                            </div>
                            
                        </div>
                    </div>
                </div>
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">ðŸŽ¥ Video Demo Link</h3>
                    <a href="https://drive.google.com/drive/folders/1xZ6WeAzjRwC87m2hUdyxYPTxBF8juYOo" target="_blank" class="text-purple-600 hover:text-purple-800 font-medium transition duration-150 underline">
                        module 1
                    </a>
                </div>
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Camera Calibration Data</h3>
                    <div class="mt-4 p-4 bg-purple-100 border border-purple-300 rounded-lg">
                        
                        <p class="font-medium text-purple-800 mb-2">Full Camera Matrix (K):</p>
                        <div class="code-display mb-4">
[[3.08184216e+03 0.00000000e+00 2.04770241e+03]
 [0.00000000e+00 3.07733506e+03 1.70927427e+03]
 [0.00000000e+00 0.00000000e+00 1.00000000e+00]]
                        </div>

                        <p class="font-medium text-purple-800 mb-2">Distortion Coefficients (D):</p>
                        <div class="code-display">
[-0.05664841 0.12756379 -0.00213582 0.00925428 -0.0946181 ]
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </main>

    <script>

        const FX = 3081.84216;
        const FY = 3077.33506;
        

        const objectCanvas = document.getElementById('object-canvas');
        const ctxM1 = objectCanvas.getContext('2d');
        const fileInputM1 = document.getElementById('image-upload-m1');
        const calculateButtonM1 = document.getElementById('calculate-button-m1');
        const resetButtonM1 = document.getElementById('reset-button-m1');
        const depthInputM1 = document.getElementById('Z_m1');
        const realDXInput = document.getElementById('real_dX');
        const realDYInput = document.getElementById('real_dY');
        const ZDisplay = document.getElementById('Z-display');
        const consoleResults = document.getElementById('console-results');


        let originalImageM1 = null;
        let pointsM1 = []; 
        const MAX_CANVAS_WIDTH = 400;


        fileInputM1.addEventListener('change', handleImageUploadM1);
        objectCanvas.addEventListener('click', handleCanvasClickM1);
        calculateButtonM1.addEventListener('click', calculateDimensionM1);
        resetButtonM1.addEventListener('click', resetModule1);
        
        resetModule1();
        
        function handleImageUploadM1(e) {
            if (e.target.files.length === 0) {
                resetModule1();
                return;
            }

            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {

                    originalImageM1 = img;
                    
                    pointsM1 = [];
                    
                    drawInteractiveImage();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }


        function resetModule1() {
            pointsM1 = [];
            originalImageM1 = null;
            objectCanvas.width = MAX_CANVAS_WIDTH;
            objectCanvas.height = 300;
            ctxM1.clearRect(0, 0, objectCanvas.width, objectCanvas.height);
            ctxM1.textAlign = 'center';
            ctxM1.fillStyle = '#6b7280';
            ctxM1.fillText("Upload an image to begin.", objectCanvas.width / 2, objectCanvas.height / 2);
            calculateButtonM1.disabled = true;
            
            document.getElementById('Z_m1').value = '0';
            document.getElementById('real_dX').value = '0';
            document.getElementById('real_dY').value = '0';
            document.getElementById('image-upload-m1').value = ''; // Clear file input

            consoleResults.innerHTML = 'Awaiting input...';
        }


        function drawInteractiveImage() {
            if (!originalImageM1) return;

            let width = originalImageM1.width;
            let height = originalImageM1.height;
            
            if (width > MAX_CANVAS_WIDTH) {
                const ratio = MAX_CANVAS_WIDTH / width;
                width = MAX_CANVAS_WIDTH;
                height = Math.floor(height * ratio);
            }

            objectCanvas.width = width;
            objectCanvas.height = height;

            ctxM1.drawImage(originalImageM1, 0, 0, width, height);

            pointsM1.forEach((p, index) => {
                ctxM1.beginPath();
                ctxM1.fillStyle = index === 0 ? '#3b82f6' : '#ef4444'; 
                ctxM1.arc(p.displayX, p.displayY, 5, 0, Math.PI * 2); 
                ctxM1.fill();

                ctxM1.fillStyle = '#1f2937';
                ctxM1.font = '12px Inter';
                ctxM1.fillText(`P${index + 1}`, p.displayX + 8, p.displayY - 5);
            });

            if (pointsM1.length === 2) {
                ctxM1.beginPath();
                ctxM1.strokeStyle = '#a78bfa';
                ctxM1.lineWidth = 2;
                ctxM1.moveTo(pointsM1[0].displayX, pointsM1[0].displayY); 
                ctxM1.lineTo(pointsM1[1].displayX, pointsM1[1].displayY); 
                ctxM1.stroke();
                calculateButtonM1.disabled = false;
            } else {
                calculateButtonM1.disabled = true;
            }
        }

        function handleCanvasClickM1(e) {
            if (!originalImageM1) return;

            const scaleFactor = originalImageM1.width / objectCanvas.width;
            const x = e.offsetX * scaleFactor;
            const y = e.offsetY * scaleFactor;
            
            const displayX = e.offsetX;
            const displayY = e.offsetY;

            if (pointsM1.length < 2) {
                pointsM1.push({ x: x, y: y, displayX: displayX, displayY: displayY });
            } else {
                pointsM1 = [{ x: x, y: y, displayX: displayX, displayY: displayY }];
            }

            drawInteractiveImage();
            
            if (pointsM1.length === 1) {

                consoleResults.innerHTML = `(xâ‚, yâ‚) = (${pointsM1[0].x.toFixed(1)}, ${pointsM1[0].y.toFixed(1)})`;
            } else if (pointsM1.length === 2) {
                consoleResults.innerHTML = 'Two points selected. Click "Calculate Dimension & Error" to view results.';
            } else {
                consoleResults.innerHTML = 'Awaiting input...';
            }
        }

        function calculateDimensionM1(e, autoUpdate = false) {
            if (e) e.preventDefault();
            if (pointsM1.length !== 2 || !originalImageM1) return;

            const Z = parseFloat(depthInputM1.value);
            const real_dX = parseFloat(realDXInput.value);
            const real_dY = parseFloat(realDYInput.value);
            
            
            if (isNaN(Z) || Z <= 0) {
                 consoleResults.innerHTML = '<p class="text-red-600 font-semibold">Please enter a valid Z value greater than 0 cm.</p>';
                 return;
            }

            const p1 = pointsM1[0];
            const p2 = pointsM1[1];

            fetch("/compute", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({p1, p2, Z, real_dX, real_dY, FX, FY})
            })
            .then(res => {
                if (!res.ok) throw new Error('Server computation failed.');
                return res.json();
            })
            .then(data => {
                const dX = data.dX;
                const dY = data.dY;
                const error = data.error;

                const dx = Math.abs(p2.x - p1.x);
                const dy = Math.abs(p2.y - p1.y);


                consoleResults.innerHTML = 
                    `(xâ‚, yâ‚) = (${p1.x.toFixed(1)}, ${p1.y.toFixed(1)})\n` +
                    `(xâ‚‚, yâ‚‚) = (${p2.x.toFixed(1)}, ${p2.y.toFixed(1)})\n` +
                    `Î”x = ${dx.toFixed(1)} px, Î”y = ${dy.toFixed(1)} px\n` +
                    `Î”X = ${dX} cm, Î”Y = ${dY} cm\n` +
                    `Error = ${error} cm`;
                // -------------------------------------
            })
            .catch(error => {
                console.error("Calculation error:", error);
                consoleResults.innerHTML = `<p class="text-red-600 font-semibold">Error: Could not reach server (${error.message}).</p>`;
            });
        }
    </script>
</body>
</html>